<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8 />
    <title>Cartemploi</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.9/mapbox.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.9/mapbox.css' rel='stylesheet' />
    <style>
      body {margin:0; padding:0;}
      #map {position:absolute; top:0; bottom:0; width:100%;}
      .search-ui {position:absolute; top:47px; right:50px; z-index:1000;}
      .button {position:absolute; top:47px; right: 30px; z-index:1000;}
      .block_text {position:absolute; background-color:white; color:#686868; padding-left:6px; border: 1px black solid; top:15px; right:15px; width:400px; box-shadow: 5px 5px 5px #888888; z-index:1000;}
      .text {font-size:12px; color:black;}
    </style>
  </head>
  <body>
    <div id='map'></div>
    <div class='block_text'><h1>Cartemploi<h1><p class='text'>Une carte pour géolocaliser vos offres d'emploi partout en France</p><p class='text'>En partenariat avec Pole Emploi</div>
    <input id='search' class='search-ui' placeholder='Recherche par métier' />
    <button type="button" id='button' class='button'>OK</button>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script>
      L.mapbox.accessToken = 'pk.eyJ1IjoiYmxhY2t5IiwiYSI6IjA4NWJjZDNiNDQ0MTg3YjVmZTNkM2NkMWQ3MmM4ZjU4In0.SDQh56AZPCbIL2rVs4eAkQ';
      var map = L.mapbox.map('map', 'mapbox.streets').setView([48.855, 2.4], 12);
      
      function getMarker(response) {
        clearMarkers();
        $.each(response, function(i) {  
          title = response[i].title;              
          latitude = response[i].latitude;
          longitude = response[i].longitude
          
          markerGroup.push(L.mapbox.featureLayer({
          
          // this feature is in the GeoJSON format: see geojson.org
          // for the full specification
            type: 'Feature',
            geometry: {
                type: 'Point',
                // coordinates here are in longitude, latitude order because
                // x, y is the standard for GeoJSON and many formats
                coordinates: [
                  longitude,
                  latitude
                ]
            },
            properties: {
                title: title,
                description : '',
                // one can customize markers by adding simplestyle properties
                // https://www.mapbox.com/guides/an-open-platform/#simplestyle
                'marker-size': 'large',
                'marker-color': '#ffa500',
                'marker-symbol': 'suitcase'
            }
          }).addTo(map));
        });
      }
      
      var markerGroup = [];
      
      /*
      $('#search').keyup(search);
      
      //debug = null;
      
      function search() {
        // get the value of the search input field
        var searchString = $('#search').val().toLowerCase();
        
        regexp = new RegExp(document.getElementById("search").value, "i");
        markerGroup.forEach(function(marker) {
            console.log(marker);
            debug = marker;
            if(!regexp.test(marker.properties.title)) {
                marker.clearLayers();
            }
        });
       
        
        console.log(searchString)
      }
      
      function showJobs(feature) {
        return feature.properties.title;
      }*/
      
      function clearMarkers() {
        markerGroup.forEach(function(marker) {
          marker.clearLayers();
        });
        
        markerGroup = [];
      }
    
      $("#button").on('click', function(event) {
        event.preventDefault();
        $.ajax({
          type: 'GET',
          url: '/search/'+ document.getElementById('search').value + '?limit=20&p=1',
          crossDomain: true,
          dataType: 'json',
          contentType: "application/json",
          success : function(response) {
            getMarker(response);
          }
        });
      });
      
      map.on('moveend', function(move) {
        
        var coordinates = map.getCenter();
        
          $.ajax({
            type: 'GET',
            url: '/geosearch/'+ coordinates.lat + ',' + coordinates.lng + '?text=' + document.getElementById('search').value + '&d=20&limit=20&p=1',
            crossDomain: true,
            dataType: 'json',
            contentType: "application/json",
            success : function(response) {
              getMarker(response);
            }
          });
      });

      $(document).ready(function() {
        $.ajax({
          type: 'GET',
          url: '/emploi?limit=20&p=1',
          crossDomain: true,
          dataType: 'json',
          contentType: "application/json",
          success: function(response) {
            getMarker(response);
          }
        });
      });
    </script>
    
  </body>
</html>
    </style>
