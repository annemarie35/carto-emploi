<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8 />
    <title>A simple map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.9/mapbox.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.9/mapbox.css' rel='stylesheet' />
    <style>
      body { margin:0; padding:0; }
      #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
  </head>
  <body>
    <div id='map'></div>
    <script>
      L.mapbox.accessToken = 'pk.eyJ1IjoiYmxhY2t5IiwiYSI6IjA4NWJjZDNiNDQ0MTg3YjVmZTNkM2NkMWQ3MmM4ZjU4In0.SDQh56AZPCbIL2rVs4eAkQ';
      var map = L.mapbox.map('map', 'mapbox.streets').setView([47, 2], 6);
      
      map.on('moveend',function(move) {
      
        var coordinates = map.getCenter();
        console.log(coordinates.lat)
        
          
          $(document).ready(function(){
            $.ajax({
              type: 'GET',
              url: 'http://private-anon-0b8fcf12d-cartoemploi.apiary-mock.com/geosearch/'+ coordinates.lat + ',' + coordinates.lng,
              crossDomain: true,
              dataType: 'json',
              contentType: "application/json",
              success: function(response) {
                $.each(response, function(i) {  
                  title = response[i].title;              
                  latitude = response[i].latitude;
                  longitude = response[i].longitude
                  
                  var markerGroup = L.mapbox.featureLayer({
                  
                  // this feature is in the GeoJSON format: see geojson.org
                  // for the full specification
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        // coordinates here are in longitude, latitude order because
                        // x, y is the standard for GeoJSON and many formats
                        coordinates: [
                          longitude,
                          latitude
                        ]
                    },
                    properties: {
                        title: title,
                        description : '',
                        // one can customize markers by adding simplestyle properties
                        // https://www.mapbox.com/guides/an-open-platform/#simplestyle
                        'marker-size': 'large',
                        'marker-color': '#ffa500',
                        'marker-symbol': 'suitcase'
                    }
                  }).addTo(map);
                  
                  
                  markerGroup.clearLayers();
                  console.log(markerGroup)
                });
              }
            });
          });
      });

      $(document).ready(function(){
        $.ajax({
          type: 'GET',
          url: 'http://private-anon-0b8fcf12d-cartoemploi.apiary-mock.com/emploi',
          crossDomain: true,
          dataType: 'json',
          contentType: "application/json",
          success: function(response) {
            $.each(response, function(i) {  
              title = response[i].title;              
              latitude = response[i].latitude;
              longitude = response[i].longitude
              
              L.mapbox.featureLayer({
              
              // this feature is in the GeoJSON format: see geojson.org
              // for the full specification
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    // coordinates here are in longitude, latitude order because
                    // x, y is the standard for GeoJSON and many formats
                    coordinates: [
                      longitude,
                      latitude
                    ]
                },
                properties: {
                    title: title,
                    description : '',
                    // one can customize markers by adding simplestyle properties
                    // https://www.mapbox.com/guides/an-open-platform/#simplestyle
                    'marker-size': 'large',
                    'marker-color': '#ffa500',
                    'marker-symbol': 'suitcase'
                }
              }).addTo(map);
            });
          }
        });
      });
    </script>
  </body>
</html>
